apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: nxt-REPLACE_NAMESPACE
  name: REPLACE_POD_NAME
  labels:
    app: REPLACE_POD_NAME
spec:
  replicas: REPLACE_REPLICAS
  selector:
    matchLabels:
      app: REPLACE_POD_NAME
  serviceName: REPLACE_POD_NAME
  template:
    metadata:
      annotations:
        sidecar.istio.io/statsInclusionPrefixes: listener,cluster.outbound,cluster.inbound,cluster.http2,cluster_manager,listener_manager,http_mixer_filter,tcp_mixer_filter,server,cluster.xds-grpc
        # All the above stats are just for debugging, but the below stats is enabled
        # so that envoy health checking works properly, or so is claimed by the below link
        # https://github.com/istio/istio/issues/10537
        sidecar.istio.io/statsInclusionSuffixes: upstream_cx_total
        # add nxt custom stats dimension
        sidecar.istio.io/extraStatTags: nxt_session,nxt_for,nxt_srcAgent,nxt_srcPod,nxt_srcCluster,nxt_destCluster,nxt_uuid
      labels:
        app: REPLACE_POD_NAME
        role: minion
    spec:
      containers:
      - name: minion
        image: REPLACE_IMAGE
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        - containerPort: 443
        - containerPort: 8080
        env:
          - name: MY_NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: MY_POD_NAME
            value: "REPLACE_POD_NAME"
          - name: MY_POD_TYPE
            value: "cpod"
          - name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: MY_POD_CLUSTER
            value: "REPLACE_CLUSTER"
          - name: MY_MONGO_URI
            value: "REPLACE_MONGO"
      imagePullSecrets:
      - name: regcred
